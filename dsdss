-- Water Client v3.4 - Admin Panel
-- LocalScript -> StarterGui
-- Added switch system and jail functionality

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
if not player then Players:GetPropertyChangedSignal("LocalPlayer"):Wait(); player = Players.LocalPlayer end
local playerGui = player:WaitForChild("PlayerGui")

local ACTIVATION_KEY = "WATER2025"

local THEME = {
    panel = Color3.fromRGB(22,22,28),
    accent = Color3.fromRGB(72,137,255),
    text = Color3.fromRGB(240,240,245),
    muted = Color3.fromRGB(170,170,180),
    dark = Color3.fromRGB(8,8,10),
    bad = Color3.fromRGB(220,60,60),
    good = Color3.fromRGB(80,200,120),
    switch_bg = Color3.fromRGB(45,45,50),
    switch_on = Color3.fromRGB(80,200,120)
}

-- Storage per le prigioni
local jailedPlayers = {}

local function c(class, props)
    local obj = Instance.new(class)
    if props then for k,v in pairs(props) do pcall(function() obj[k] = v end) end end
    return obj
end

local function safeTween(obj, info, props)
    if not obj or not obj.Parent then return end
    local ok, t = pcall(function() return TweenService:Create(obj, info, props) end)
    if not ok or not t then return end
    pcall(function() t:Play() end)
    return t
end

-- Funzione per creare prigione di ghiaccio
local function createJail(targetPlayer)
    if not targetPlayer or not targetPlayer.Character or not targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
        return false
    end
    
    local character = targetPlayer.Character
    local rootPart = character.HumanoidRootPart
    local position = rootPart.Position
    
    -- Rimuovi prigione esistente se presente
    if jailedPlayers[targetPlayer.UserId] then
        for _, part in pairs(jailedPlayers[targetPlayer.UserId]) do
            if part and part.Parent then
                pcall(function() part:Destroy() end)
            end
        end
    end
    
    local jailParts = {}
    local jailSize = 8
    local wallHeight = 12
    
    -- Crea le pareti della prigione
    local wallPositions = {
        -- Pareti
        {Vector3.new(position.X + jailSize/2, position.Y + wallHeight/2, position.Z), Vector3.new(1, wallHeight, jailSize)}, -- Destra
        {Vector3.new(position.X - jailSize/2, position.Y + wallHeight/2, position.Z), Vector3.new(1, wallHeight, jailSize)}, -- Sinistra
        {Vector3.new(position.X, position.Y + wallHeight/2, position.Z + jailSize/2), Vector3.new(jailSize, wallHeight, 1)}, -- Avanti
        {Vector3.new(position.X, position.Y + wallHeight/2, position.Z - jailSize/2), Vector3.new(jailSize, wallHeight, 1)}, -- Dietro
        -- Soffitto
        {Vector3.new(position.X, position.Y + wallHeight, position.Z), Vector3.new(jailSize, 1, jailSize)}, -- Soffitto
        -- Pavimento
        {Vector3.new(position.X, position.Y - 1, position.Z), Vector3.new(jailSize, 1, jailSize)}, -- Pavimento
    }
    
    for i, data in ipairs(wallPositions) do
        local pos, size = data[1], data[2]
        local part = c("Part", {
            Parent = workspace,
            Size = size,
            Position = pos,
            Material = Enum.Material.Ice,
            BrickColor = BrickColor.new("Pastel blue"),
            CanCollide = true,
            Anchored = true,
            Transparency = 0.3,
            Name = "JailWall_" .. targetPlayer.Name .. "_" .. i
        })
        
        -- Effetto glow
        local pointLight = c("PointLight", {
            Parent = part,
            Color = Color3.fromRGB(173, 216, 230),
            Brightness = 0.5,
            Range = 8
        })
        
        table.insert(jailParts, part)
    end
    
    jailedPlayers[targetPlayer.UserId] = jailParts
    
    -- Suono di creazione prigione
    local sound = c("Sound", {
        Parent = rootPart,
        SoundId = "rbxasset://sounds/impact_water.mp3",
        Volume = 0.5
    })
    pcall(function() sound:Play() end)
    delay(2, function() if sound then sound:Destroy() end end)
    
    return true
end

-- Funzione per rimuovere prigione
local function removeJail(targetPlayer)
    if not jailedPlayers[targetPlayer.UserId] then return false end
    
    for _, part in pairs(jailedPlayers[targetPlayer.UserId]) do
        if part and part.Parent then
            safeTween(part, TweenInfo.new(0.5, Enum.EasingStyle.Quad), {Transparency = 1})
            delay(0.5, function() pcall(function() part:Destroy() end) end)
        end
    end
    
    jailedPlayers[targetPlayer.UserId] = nil
    return true
end

-- clean previous (if any) to avoid duplicates in Studio hot-reloads
for _,g in pairs(playerGui:GetChildren()) do
    if g.Name == "WaterClientGUI" then pcall(function() g:Destroy() end) end
end

local screenGui = c("ScreenGui", {Name = "WaterClientGUI", ResetOnSpawn = false, Parent = playerGui})
screenGui.IgnoreGuiInset = true
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
if syn and syn.protect_gui then pcall(syn.protect_gui, screenGui) end
c("UIScale", {Parent = screenGui, Scale = 1})

-- ---------- MINIMIZED CIRCLE ----------
local minimizedCircle = c("Frame", {
    Name = "MinimizedCircle",
    Parent = screenGui,
    Size = UDim2.new(0, 60, 0, 60),
    Position = UDim2.new(1, -80, 0, 20),
    BackgroundColor3 = THEME.accent,
    BorderSizePixel = 0,
    Visible = false,
    ZIndex = 100
})
c("UICorner", {Parent = minimizedCircle, CornerRadius = UDim.new(1, 0)})

local circleIcon = c("TextLabel", {
    Parent = minimizedCircle,
    Text = "W",
    Font = Enum.Font.GothamBlack,
    TextSize = 24,
    TextColor3 = Color3.fromRGB(255, 255, 255),
    BackgroundTransparency = 1,
    Size = UDim2.new(1, 0, 1, 0),
    TextXAlignment = Enum.TextXAlignment.Center,
    TextYAlignment = Enum.TextYAlignment.Center
})

local circleButton = c("TextButton", {
    Parent = minimizedCircle,
    Size = UDim2.new(1, 0, 1, 0),
    BackgroundTransparency = 1,
    Text = ""
})

-- ---------- MAIN GUI ----------
local main = c("Frame", {
    Name = "Main",
    Parent = screenGui,
    AnchorPoint = Vector2.new(0.5,0.5),
    Position = UDim2.new(0.5,0,0.5,0),
    Size = UDim2.new(0,460,0,280),
    BackgroundColor3 = THEME.panel,
    BorderSizePixel = 0,
    Visible = false,
    ClipsDescendants = true
})
c("UICorner", {Parent = main, CornerRadius = UDim.new(0,14)})

-- Topbar
local topBar = c("Frame", {Parent = main, Size = UDim2.new(1,0,0,52), BackgroundTransparency = 1})
local title = c("TextLabel", {Parent = topBar, Text = "WATER ADMIN", Font = Enum.Font.GothamBold, TextSize = 20, TextColor3 = THEME.text, BackgroundTransparency = 1})
title.AnchorPoint = Vector2.new(0.5,0.5)
title.Position = UDim2.new(0.5,0,0.5,0)

local icon = c("Frame", {Parent = topBar, Size = UDim2.new(0,56,0,56), Position = UDim2.new(0,8,0,-2), BackgroundColor3 = THEME.dark})
c("UICorner", {Parent = icon, CornerRadius = UDim.new(0,10)})
c("TextLabel", {Parent = icon, Text = "W", Font = Enum.Font.GothamBlack, TextSize = 22, TextColor3 = THEME.accent, BackgroundTransparency = 1, Size = UDim2.new(1,0,1,0)})

-- Close / Minimize
local closeBtn = c("TextButton", {Parent = topBar, Size = UDim2.new(0,30,0,30), Position = UDim2.new(1,-44,0,11), BackgroundColor3 = Color3.fromRGB(40,40,44), Text = "✕", Font = Enum.Font.Gotham, TextSize = 18, TextColor3 = THEME.text, BorderSizePixel = 0})
c("UICorner", {Parent = closeBtn, CornerRadius = UDim.new(0,6)})
local miniBtn = c("TextButton", {Parent = topBar, Size = UDim2.new(0,30,0,30), Position = UDim2.new(1,-88,0,11), BackgroundColor3 = Color3.fromRGB(40,40,44), Text = "—", Font = Enum.Font.Gotham, TextSize = 18, TextColor3 = THEME.muted, BorderSizePixel = 0})
c("UICorner", {Parent = miniBtn, CornerRadius = UDim.new(0,6)})

-- Tabs
local tabsFrame = c("Frame", {Parent = main, Position = UDim2.new(0,16,0,70), Size = UDim2.new(0,130,0,190), BackgroundTransparency = 1})
c("UIListLayout", {Parent = tabsFrame, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0,10)})
c("UIPadding", {Parent = tabsFrame, PaddingTop = UDim2.new(0,4), PaddingLeft = UDim2.new(0,4)})
local tabNames = {"Main","ESP","Misc","Other"}
local tabButtons = {}
for i,name in ipairs(tabNames) do
    local b = c("TextButton", {Parent = tabsFrame, Size = UDim2.new(1,-8,0,40), BackgroundColor3 = Color3.fromRGB(30,30,36), Text = name, Font = Enum.Font.Gotham, TextSize = 15, TextColor3 = THEME.muted, BorderSizePixel = 0})
    c("UICorner", {Parent = b, CornerRadius = UDim.new(0,8)})
    b.LayoutOrder = i
    tabButtons[name] = b
end

-- Content and holder
local content = c("Frame", {Parent = main, Position = UDim2.new(0,162,0,70), Size = UDim2.new(0,280,0,190), BackgroundColor3 = THEME.dark, BorderSizePixel = 0})
c("UICorner", {Parent = content, CornerRadius = UDim.new(0,10)})
c("UIPadding", {Parent = content, PaddingTop = UDim2.new(0,12), PaddingLeft = UDim2.new(0,12)})
local contentHolder = c("Frame", {Parent = content, Size = UDim2.new(1,0,1,0), BackgroundTransparency = 1})
contentHolder.Name = "ContentHolder"

-- Dropdown per player selection
local playerDropdown = c("Frame", {
    Parent = screenGui,
    Size = UDim2.new(0, 200, 0, 150),
    BackgroundColor3 = THEME.panel,
    BorderSizePixel = 0,
    Visible = false,
    ZIndex = 200
})
c("UICorner", {Parent = playerDropdown, CornerRadius = UDim.new(0, 8)})
c("UIStroke", {Parent = playerDropdown, Color = THEME.accent, Thickness = 1})

local dropdownScroll = c("ScrollingFrame", {
    Parent = playerDropdown,
    Size = UDim2.new(1, -8, 1, -8),
    Position = UDim2.new(0, 4, 0, 4),
    BackgroundTransparency = 1,
    ScrollBarThickness = 6,
    ScrollBarImageColor3 = THEME.accent
})
c("UIListLayout", {Parent = dropdownScroll, Padding = UDim.new(0, 2)})

local currentDropdownAction = nil

local function updatePlayerDropdown(action)
    currentDropdownAction = action
    for _, child in pairs(dropdownScroll:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end
    
    local playerCount = 0
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= player then
            playerCount = playerCount + 1
            local btn = c("TextButton", {
                Parent = dropdownScroll,
                Size = UDim2.new(1, 0, 0, 30),
                BackgroundColor3 = Color3.fromRGB(35, 35, 40),
                Text = plr.Name,
                Font = Enum.Font.Gotham,
                TextSize = 14,
                TextColor3 = THEME.text,
                BorderSizePixel = 0
            })
            c("UICorner", {Parent = btn, CornerRadius = UDim.new(0, 6)})
            
            btn.MouseButton1Click:Connect(function()
                if action == "jail" then
                    createJail(plr)
                elseif action == "unjail" then
                    removeJail(plr)
                end
                playerDropdown.Visible = false
            end)
            
            btn.MouseEnter:Connect(function()
                safeTween(btn, TweenInfo.new(0.15), {BackgroundColor3 = THEME.accent})
            end)
            btn.MouseLeave:Connect(function()
                safeTween(btn, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(35, 35, 40)})
            end)
        end
    end
    
    dropdownScroll.CanvasSize = UDim2.new(0, 0, 0, playerCount * 32)
end

-- Chiudi dropdown cliccando fuori
UserInputService.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        if playerDropdown.Visible then
            local mousePos = UserInputService:GetMouseLocation()
            local dropdownPos = playerDropdown.AbsolutePosition
            local dropdownSize = playerDropdown.AbsoluteSize
            
            if mousePos.X < dropdownPos.X or mousePos.X > dropdownPos.X + dropdownSize.X or
               mousePos.Y < dropdownPos.Y or mousePos.Y > dropdownPos.Y + dropdownSize.Y then
                playerDropdown.Visible = false
            end
        end
    end
end)

-- ---------- Activation popup creator function ----------
local overlayRef = nil
local popupRefs = {}

local function createActivationPopup()
    if overlayRef and overlayRef.Parent then pcall(function() overlayRef:Destroy() end) end
    overlayRef = c("Frame", {Parent = screenGui, Size = UDim2.new(1,0,1,0), BackgroundTransparency = 0.6, BackgroundColor3 = Color3.fromRGB(0,0,0), ZIndex = 50})
    overlayRef.Visible = true

    local popupCard = c("Frame", {Parent = overlayRef, Size = UDim2.new(0,380,0,180), AnchorPoint = Vector2.new(0.5,0.5), Position = UDim2.new(0.5,0,0.45,0), BackgroundColor3 = THEME.panel, BorderSizePixel = 0, ZIndex = 51})
    c("UICorner", {Parent = popupCard, CornerRadius = UDim.new(0,14)})

    local header = c("Frame", {Parent = popupCard, Size = UDim2.new(1,0,0,64), BackgroundTransparency = 0})
    local headerGrad = c("UIGradient", {Parent = header, Rotation = 90})
    headerGrad.Color = ColorSequence.new{ColorSequenceKeypoint.new(0, THEME.accent), ColorSequenceKeypoint.new(1, Color3.fromRGB(40,80,180))}
    local popupTitle = c("TextLabel", {Parent = header, Text = "WATER ADMIN", Font = Enum.Font.GothamBold, TextSize = 20, TextColor3 = Color3.fromRGB(255,255,255), BackgroundTransparency = 1})
    popupTitle.AnchorPoint = Vector2.new(0.5,0.5)
    popupTitle.Position = UDim2.new(0.5,0,0.5,0)
    local popupSubtitle = c("TextLabel", {Parent = header, Text = "Insert key to unlock the admin panel", Font = Enum.Font.Gotham, TextSize = 14, TextColor3 = Color3.fromRGB(230,230,235), BackgroundTransparency = 1})
    popupSubtitle.AnchorPoint = Vector2.new(0.5,0,0,0)
    popupSubtitle.Position = UDim2.new(0.5,0,0.8,0)

    local keyArea = c("Frame", {Parent = popupCard, Size = UDim2.new(1, -32, 0, 84), Position = UDim2.new(0,16,0,72), BackgroundTransparency = 1})
    local keyBox = c("TextBox", {Parent = keyArea, Size = UDim2.new(1,0,0,44), Position = UDim2.new(0,0,0,0), Text = "", Font = Enum.Font.Gotham, TextSize = 18, TextColor3 = THEME.text, BackgroundColor3 = Color3.fromRGB(28,28,34), PlaceholderText = "Insert key...", ClearTextOnFocus = false})
    c("UICorner", {Parent = keyBox, CornerRadius = UDim.new(0,10)})
    local keyStripe = c("Frame", {Parent = keyBox, Size = UDim2.new(0,8,1,0), Position = UDim2.new(0,0,0,0), BackgroundColor3 = THEME.accent})
    c("UICorner", {Parent = keyStripe, CornerRadius = UDim.new(0,8)})

    local statusLabel = c("TextLabel", {Parent = keyArea, Text = "", Font = Enum.Font.Gotham, TextSize = 14, TextColor3 = THEME.muted, BackgroundTransparency = 1, Position = UDim2.new(0,0,0,50), Size = UDim2.new(1,0,0,18), TextXAlignment = Enum.TextXAlignment.Center})

    local btnActivate = c("TextButton", {Parent = popupCard, Text = "Activate", Font = Enum.Font.GothamBold, TextSize = 16, TextColor3 = Color3.fromRGB(255,255,255), BackgroundColor3 = THEME.accent, Size = UDim2.new(0,180,0,40), Position = UDim2.new(0.5,-90,0,124)})
    c("UICorner", {Parent = btnActivate, CornerRadius = UDim.new(0,8)})

    popupCard.Position = UDim2.new(0.5,0,0.2,0)
    popupCard.Size = UDim2.new(0,320,0,140)
    popupCard.BackgroundTransparency = 1
    safeTween(popupCard, TweenInfo.new(0.36, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Position = UDim2.new(0.5,0,0.45,0), Size = UDim2.new(0,380,0,180), BackgroundTransparency = 0})

    local function shakeGui(gui)
        if not gui then return end
        local orig = gui.Position
        local seq = {-10,10,-6,6,-4,4,0}
        for i,v in ipairs(seq) do
            delay(0.03*i, function() pcall(function() gui.Position = orig + UDim2.new(0,v,0,0) end) end)
        end
        delay(0.25, function() pcall(function() gui.Position = orig end) end)
    end

    local function showStatus(text, color)
        statusLabel.Text = text
        statusLabel.TextColor3 = color or THEME.muted
        delay(2, function() if statusLabel and statusLabel.Parent then pcall(function() statusLabel.Text = "" end) end end)
    end

    local function tryActivate(key)
        key = (key or ""):gsub("%s+","")
        if key == "" then
            safeTween(keyBox, TweenInfo.new(0.08), {BackgroundColor3 = Color3.fromRGB(40,40,44)})
            shakeGui(keyBox)
            showStatus("Please enter a key", THEME.bad)
            return false
        end
        if key == ACTIVATION_KEY then
            safeTween(keyStripe, TweenInfo.new(0.12), {BackgroundColor3 = THEME.good})
            safeTween(keyBox, TweenInfo.new(0.18), {BackgroundColor3 = Color3.fromRGB(24,36,24)})
            showStatus("Key accepted — unlocking...", THEME.good)
            safeTween(overlayRef, TweenInfo.new(0.32, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {BackgroundTransparency = 1})
            safeTween(popupCard, TweenInfo.new(0.28, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {Position = UDim2.new(0.5,0,0.2,0), Size = UDim2.new(0,300,0,120), BackgroundTransparency = 1})
            delay(0.36, function()
                if overlayRef and overlayRef.Parent then pcall(function() overlayRef:Destroy() end) end
                main.Visible = true
                main.Position = UDim2.new(0.5,0,-0.6,0)
                safeTween(main, TweenInfo.new(0.42, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Position = UDim2.new(0.5,0,0.5,0)})
            end)
            return true
        else
            safeTween(keyStripe, TweenInfo.new(0.09), {BackgroundColor3 = THEME.bad})
            safeTween(keyBox, TweenInfo.new(0.14), {BackgroundColor3 = Color3.fromRGB(44,22,22)})
            shakeGui(keyBox)
            showStatus("Invalid key. Try again.", THEME.bad)
            return false
        end
    end

    btnActivate.MouseButton1Click:Connect(function() tryActivate(keyBox.Text) end)
    keyBox.FocusLost:Connect(function(enter) if enter then tryActivate(keyBox.Text) end end)

    popupRefs.overlay = overlayRef
    popupRefs.card = popupCard
    popupRefs.keyBox = keyBox
end

createActivationPopup()

-- ---------- MAIN TAB CONTENT ----------
local function createMainContent()
    for _,v in pairs(contentHolder:GetChildren()) do pcall(function() v:Destroy() end) end
    
    local holder = c("Frame", {Parent = contentHolder, Size = UDim2.new(1,0,1,0), BackgroundTransparency = 1})
    c("UIListLayout", {Parent = holder, Padding = UDim.new(0, 12), FillDirection = Enum.FillDirection.Vertical})
    
    -- Jail Button
    local jailFrame = c("Frame", {Parent = holder, Size = UDim2.new(1, 0, 0, 50), BackgroundTransparency = 1})
    local jailLabel = c("TextLabel", {Parent = jailFrame, Text = "Jail Player", Font = Enum.Font.GothamBold, TextSize = 16, TextColor3 = THEME.text, BackgroundTransparency = 1, Size = UDim2.new(0.6, 0, 1, 0)})
    
    local jailBtn = c("TextButton", {
        Parent = jailFrame,
        Size = UDim2.new(0, 100, 0, 40),
        Position = UDim2.new(1, -100, 0.5, -20),
        BackgroundColor3 = THEME.switch_bg,
        Text = "Select Player",
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextColor3 = THEME.text,
        BorderSizePixel = 0
    })
    c("UICorner", {Parent = jailBtn, CornerRadius = UDim.new(0, 8)})
    c("UIStroke", {Parent = jailBtn, Color = THEME.accent, Thickness = 1})
    
    jailBtn.MouseButton1Click:Connect(function()
        updatePlayerDropdown("jail")
        playerDropdown.Position = UDim2.new(0, jailBtn.AbsolutePosition.X, 0, jailBtn.AbsolutePosition.Y + jailBtn.AbsoluteSize.Y + 5)
        playerDropdown.Visible = true
    end)
    
    -- Unjail Button
    local unjailFrame = c("Frame", {Parent = holder, Size = UDim2.new(1, 0, 0, 50), BackgroundTransparency = 1})
    local unjailLabel = c("TextLabel", {Parent = unjailFrame, Text = "Unjail Player", Font = Enum.Font.GothamBold, TextSize = 16, TextColor3 = THEME.text, BackgroundTransparency = 1, Size = UDim2.new(0.6, 0, 1, 0)})
    
    local unjailBtn = c("TextButton", {
        Parent = unjailFrame,
        Size = UDim2.new(0, 100, 0, 40),
        Position = UDim2.new(1, -100, 0.5, -20),
        BackgroundColor3 = THEME.switch_bg,
        Text = "Select Player",
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextColor3 = THEME.text,
        BorderSizePixel = 0
    })
    c("UICorner", {Parent = unjailBtn, CornerRadius = UDim.new(0, 8)})
    c("UIStroke", {Parent = unjailBtn, Color = THEME.bad, Thickness = 1})
    
    unjailBtn.MouseButton1Click:Connect(function()
        updatePlayerDropdown("unjail")
        playerDropdown.Position = UDim2.new(0, unjailBtn.AbsolutePosition.X, 0, unjailBtn.AbsolutePosition.Y + unjailBtn.AbsoluteSize.Y + 5)
        playerDropdown.Visible = true
    end)
    
    -- Hover effects
    jailBtn.MouseEnter:Connect(function()
        safeTween(jailBtn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 60, 65)})
    end)
    jailBtn.MouseLeave:Connect(function()
        safeTween(jailBtn, TweenInfo.new(0.2), {BackgroundColor3 = THEME.switch_bg})
    end)
    
    unjailBtn.MouseEnter:Connect(function()
        safeTween(unjailBtn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 60, 65)})
    end)
    unjailBtn.MouseLeave:Connect(function()
        safeTween(unjailBtn, TweenInfo.new(0.2), {BackgroundColor3 = THEME.switch_bg})
    end)
end

local function populateTab(name)
    for n,b in pairs(tabButtons) do
        local targetBg = (n == name) and THEME.accent or Color3.fromRGB(30,30,36)
        local targetText = (n == name) and THEME.text or THEME.muted
        safeTween(b, TweenInfo.new(0.18), {BackgroundColor3 = targetBg})
        safeTween(b, TweenInfo.new(0.18), {TextColor3 = targetText})
    end
    
    if name == "Main" then
        createMainContent()
    else
        -- Placeholder per altre tab
        for _,v in pairs(contentHolder:GetChildren()) do pcall(function() v:Destroy() end) end
        local placeholder = c("TextLabel", {
            Parent = contentHolder,
            Text = "Coming Soon...",
            Font = Enum.Font.Gotham,
            TextSize = 18,
            TextColor3 = THEME.muted,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
            TextXAlignment = Enum.TextXAlignment.Center,
            TextYAlignment = Enum.TextYAlignment.Center
        })
    end
end

for name, btn in pairs(tabButtons) do
    btn.MouseButton1Click:Connect(function()
        safeTween(btn, TweenInfo.new(0.06), {Size = UDim2.new(1,-8,0,36)})
        delay(0.06, function() safeTween(btn, TweenInfo.new(0.12, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Size = UDim2.new(1,-8,0,40)}) end)
        populateTab(name)
    end)
end

populateTab("Main")

-- ---------- MINIMIZE / RESTORE ----------
local minimized = false

local function doMinimize()
    if minimized then return end
    minimized = true
    
    safeTween(main, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
        Size = UDim2.new(0, 0, 0, 0), 
        BackgroundTransparency = 1
    })
    
    delay(0.3, function()
        main.Visible = false
        minimizedCircle.Visible = true
        minimizedCircle.Size = UDim2.new(0, 20, 0, 20)
        minimizedCircle.BackgroundTransparency = 1
        safeTween(minimizedCircle, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
            Size = UDim2.new(0, 60, 0, 60),
            BackgroundTransparency = 0
        })
    end)
end

local function doRestore()
    if not minimized then return end
    minimized = false
    
    safeTween(minimizedCircle, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
        Size = UDim2.new(0, 20, 0, 20),
        BackgroundTransparency = 1
    })
    
    delay(0.25, function()
        minimizedCircle.Visible = false
        main.Visible = true
        main.Size = UDim2.new(0, 200, 0, 150)
        main.BackgroundTransparency = 1
        safeTween(main, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
            Size = UDim2.new(0, 460, 0, 280),
            BackgroundTransparency = 0
        })
    end)
end

miniBtn.MouseButton1Click:Connect(doMinimize)
circleButton.MouseButton1Click:Connect(doRestore)

circleButton.MouseEnter:Connect(function()
    safeTween(minimizedCircle, TweenInfo.new(0.2), {Size = UDim2.new(0, 70, 0, 70)})
    safeTween(minimizedCircle, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(90, 150, 255)})
end)

circleButton.MouseLeave:Connect(function()
    safeTween(minimizedCircle, TweenInfo.new(0.2), {Size = UDim2.new(0, 60, 0, 60)})
    safeTween(minimizedCircle, TweenInfo.new(0.2), {BackgroundColor3 = THEME.accent})
end)

closeBtn.MouseButton1Click:Connect(function()
    safeTween(main, TweenInfo.new(0.18), {Size = UDim2.new(0,220,0,80), BackgroundTransparency = 1})
    delay(0.18, function() if screenGui and screenGui.Parent then pcall(function() screenGui:Destroy() end) end end)
end)

-- Draggable
local dragging = false
local dragStart = Vector2.new()
local startPos = main.Position

local function inputBeganOnFrame(input)
    if input.UserInputType ~= Enum.UserInputType.MouseButton1 and input.UserInputType ~= Enum.UserInputType.Touch then return end
    if UserInputService:GetFocusedTextBox() then return end
    dragging = true
    dragStart = input.Position
    startPos = main.Position
    input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
end

main.InputBegan:Connect(inputBeganOnFrame)

UserInputService.InputChanged:Connect(function(input)
    if not dragging or minimized then return end
    if input.UserInputType ~= Enum.UserInputType.MouseMovement and input.UserInputType ~= Enum.UserInputType.Touch then return end
    local delta = input.Position - dragStart
    local view = (workspace.CurrentCamera and workspace.CurrentCamera.ViewportSize) or Vector2.new(1280,720)
    local mainW = main.AbsoluteSize.X
    local mainH = main.AbsoluteSize.Y
    if mainW <= 0 then mainW = 460 end
    if mainH <= 0 then mainH = 280 end
    local newX = startPos.X.Offset + delta.X
    local newY = startPos.Y.Offset + delta.Y
    newX = math.clamp(newX, 8, view.X - mainW - 8)
    newY = math.clamp(newY, 8, view.Y - mainH - 8)
    pcall(function() main.Position = UDim2.new(0, newX, 0, newY) end)
end)

-- Press K to reopen popup
UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == Enum.KeyCode.K then
        createActivationPopup()
    end
end)

print("Water Admin Panel v3.4 loaded with jail system.")
